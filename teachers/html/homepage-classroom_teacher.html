<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AcadBird Dashboard</title>




    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="../style/homepage-classroom_teacher.css" />
    <style>
      
    </style>
</head>

<body>
    <div class="container">
        <div class="navbar">
            <div class="logo">
                <img src="../../main/img/AcadBird - White no text.png" alt="AcadBird" class="logo-img" />
                <img src="../../main/img/AcadBird - White Text.png" class="logo-text-img" alt="AcadBird Text">
            </div>
            <img src="../../main/img/sunhill.png" alt="AcadBird" class="middle-logo" />
            <div class="nav-icons">
                <a href="notification_teacher.html" target="_blank">
                    <img src="../../main/img/Notification.png" alt="Notifications" class="icon">
                </a>
                <a href="help_teacher.html" target="_blank">
                    <img src="../../main/img/Help.png" alt="Help" class="icon">
                </a>
                <a href="settings_teacher.html" target="_blank">
                    <div class="account-menu">
                        <img src="../../main/img/account icon.png" alt="User Account" class="icon">
                    </div>
                </a>
            </div>
        </div>
        
        <div class="secondary-header">
            <nav class="nav-menu">
                <a href="homepage-teachers.html" class="nav-item">Home</a>
                <a href="homepage-classroom_teacher.html" class="nav-item active">Classroom</a>
                <a href="activitylog_teacher.html" class="nav-item">Activity Logs</a>
                <a href="resources_teacher.html" class="nav-item">Resources</a>
                <a href="messages_teacher.html" class="nav-item">Messages</a>
                <a href="studentlistpage_teacher.html" class="nav-item">Student List</a>
            </nav>
        </div>
        <div class="separator"></div>

        <div class="main-content">
            <div class="dashboard-content">
                <h1 class="dashboard-title" id="classroom-title">Loading Class Name...</h1>

                <div class="calendar-card card-section">
                    <span class="badge">Calendar</span>
                    <div class="calendar-header">
                        <a href="#" class="nav-arrow left-arrow" id="prev-month"><i class="fas fa-chevron-left"></i></a>
                        
                        <span class="calendar-month" id="current-month-year">Loading...</span> 
                        
                        <a href="#" class="nav-arrow right-arrow" id="next-month"><i class="fas fa-chevron-right"></i></a>
                    </div>
                    
                    <div class="calendar-grid">
                        <div class="day-name">Sun</div>
                        <div class="day-name">Mon</div>
                        <div class="day-name">Tue</div>
                        <div class="day-name">Wed</div>
                        <div class="day-name">Thu</div>
                        <div class="day-name">Fri</div>
                        <div class="day-name">Sat</div>
                    </div>

                    <div class="calendar-grid" id="calendar-grid">
                        </div>
                    
                    <div class="calendar-legends">
                        <div class="legend-item">
                            <span class="legend-color exam-day"></span> Exam Day
                        </div>
                        <div class="legend-item">
                            <span class="legend-color due-date"></span> Due Date
                        </div>
                        <div class="legend-item">
                            <span class="legend-color holiday"></span> Holiday
                        </div>
                    </div>
                </div>

                <div class="data-dashboard">
    <h2 class="section-title">Data Dashboard</h2>
    <div class="data-card data-card-green">
        <div class="data-number" id="student-count">--</div>
        <div class="data-label">Students<br />Logged</div>
    </div>
    <div class="data-card">
        <div class="data-number" id="parent-count">--</div>
        <div class="data-label">Parents</div>
    </div>
    <a href="participationoverview_teacher.html" class="overview-btn" style="text-decoration: none;">Add Activity Participation Overview</a>
</div>


                <div class="bottom-row">
                    <div class="top-engaged card-section">
                        <div class="card-header">Top Engaged Students</div>
                        <div class="student-list">
                            <div class="student-item">
                                <span class="student-name">First Name Lastname</span>
                                <div class="progress-bar">
                                    <div class="progress-fill-green" style="width: 100%;"></div>
                                </div>
                                <span class="progress-value">20</span>
                            </div>
                            <div class="student-item">
                                <span class="student-name">First Name Lastname</span>
                                <div class="progress-bar">
                                    <div class="progress-fill-green" style="width: 85%;"></div>
                                </div>
                                <span class="progress-value">17</span>
                            </div>
                            <div class="student-item">
                                <span class="student-name">First Name Lastname</span>
                                <div class="progress-bar">
                                    <div class="progress-fill-green" style="width: 65%;"></div>
                                </div>
                                <span class="progress-value">13</span>
                            </div>
                        </div>
                    </div>

                    <div class="low-engagement card-section">
                        <div class="card-header">Low Engagement Alerts</div>
                        <div class="student-list">
                            <div class="student-item">
                                <span class="student-name">First Name Lastname</span>
                                <div class="progress-bar">
                                    <div class="progress-fill-red" style="width: 20%;"></div>
                                </div>
                                <span class="progress-value">4</span>
                            </div>
                            <div class="student-item">
                                <span class="student-name">First Name Lastname</span>
                                <div class="progress-bar">
                                    <div class="progress-fill-red" style="width: 25%;"></div>
                                </div>
                                <span class="progress-value">5</span>
                            </div>
                            <div class="student-item">
                                <span class="student-name">First Name Lastname</span>
                                <div class="progress-bar">
                                    <div class="progress-fill-red" style="width: 35%;"></div>
                                </div>
                                <span class="progress-value">7</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-overlay">

<div class="loader-3">
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
</div>
</div>


    <div id="calendar-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePopup()">&times;</span>
            <h2 id="modal-date">March 18, 2025</h2>
            <div id="modal-details" class="modal-details">
                <p><strong>Exams:</strong> Final Exams</p>
                <p><strong>Assignments Due:</strong> Science Project</p>
                <p><strong>Events:</strong> Parent-Teacher Conference (2PM)</p>
            </div>
        </div>
    </div>
   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyB7gwN-3GVlJ-a_MTBxqVnc7Oltq5wSvHQ",
    authDomain: "acadbird-379e3.firebaseapp.com",
    projectId: "acadbird-379e3",
    storageBucket: "acadbird-379e3.firebasestorage.app",
    messagingSenderId: "575491576951",
    appId: "1:575491576951:web:70f86aba1e33b871f8a272",
    measurementId: "G-N6Z672SXWJ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await setPersistence(auth, browserLocalPersistence);

let currentDate = new Date();
const calendarGrid = document.getElementById("calendar-grid");
const currentMonthYear = document.getElementById("current-month-year");
const classroomTitle = document.getElementById("classroom-title");
const studentCountElement = document.querySelector('.data-card-green .data-number');
const loadingOverlay = document.getElementById("loading-overlay");
const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];



                    function showLoading() {
  loadingOverlay.style.display = "flex";
}

// Hide overlay
function hideLoading() {
  loadingOverlay.style.display = "none";
}


// ----------------- Calendar -----------------
function renderCalendar(date) {
    calendarGrid.innerHTML = "";
    const year = date.getFullYear();
    const month = date.getMonth();
    currentMonthYear.textContent = `${monthNames[month]} ${year}`;
    const firstDay = new Date(year, month, 1).getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
        calendarGrid.appendChild(document.createElement("div"));
    }

    for (let day = 1; day <= totalDays; day++) {
        const dayCell = document.createElement("div");
        dayCell.className = "calendar-day";
        dayCell.textContent = day;

        const today = new Date();
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            dayCell.classList.add("today");
        }

        dayCell.addEventListener("click", () => {
            openDateModal(day, month, year);
        });

        calendarGrid.appendChild(dayCell);
    }
}

document.getElementById("prev-month").addEventListener("click", (e) => {
    e.preventDefault();
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
});

document.getElementById("next-month").addEventListener("click", (e) => {
    e.preventDefault();
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
});

// Modal functions
const calendarModal = document.getElementById("calendar-modal");
const modalDateEl = document.getElementById("modal-date");
const modalDetails = document.getElementById("modal-details");

function openDateModal(day, month, year) {
    modalDateEl.textContent = `${monthNames[month]} ${day}, ${year}`;
    modalDetails.innerHTML = `<p><strong>Exams:</strong> Example Exam</p>
                              <p><strong>Assignments Due:</strong> Example Assignment</p>
                              <p><strong>Events:</strong> Example Event</p>`;
    calendarModal.style.display = "flex";
}

function closePopup() {
    calendarModal.style.display = "none";
}

// ----------------- Auth + Load Class -----------------
onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  showLoading(); // ðŸ‘ˆ show loading screen

  try {
    const teacherRef = doc(db, "users", user.uid);
    const teacherSnap = await getDoc(teacherRef);

    if (!teacherSnap.exists() || teacherSnap.data().role !== "teacher") {
      alert("Please log in as a teacher.");
      window.location.href = "../../main/html/login.html";
      return;
    }

    await loadClassData(); // wait for classroom & student data
    renderCalendar(currentDate); 

  } catch (err) {
    console.error(err);
  } finally {
    hideLoading(); // ðŸ‘ˆ hide loading screen when finished
  }
});


async function loadClassData() {
    const classId = localStorage.getItem('selectedClassId');
    const className = localStorage.getItem('selectedClassName');

    console.log("Selected classId:", classId);
    console.log("Selected className:", className);

    const classroomTitle = document.getElementById("classroom-title");
    const studentCountEl = document.getElementById("student-count");
    const parentCountEl = document.getElementById("parent-count");
    const topEngagedList = document.querySelector(".top-engaged .student-list");
    const lowEngagedList = document.querySelector(".low-engagement .student-list");

    if (!classId || !className) {
        console.log("No class selected in localStorage.");
        classroomTitle.textContent = "No class selected.";
        studentCountEl.textContent = 0;
        parentCountEl.textContent = 0;
        topEngagedList.innerHTML = "<p>No data</p>";
        lowEngagedList.innerHTML = "<p>No data</p>";
        return;
    }

    classroomTitle.textContent = className;

    try {
        // 1ï¸âƒ£ Fetch all students in the classroom
        const studentsRef = collection(db, "students");
        const studentsQuery = query(studentsRef, where("classroomId", "==", classId));
        const studentsSnapshot = await getDocs(studentsQuery);

        console.log("Students snapshot:", studentsSnapshot.docs.map(d => d.data()));

        const students = studentsSnapshot.docs.map(doc => ({
            id: doc.id,
            fullName: `${doc.data().firstName} ${doc.data().lastName}`,
            parentId: doc.data().parentId || null
        }));

        console.log("Mapped students:", students);

        const parentIds = new Set(students.map(s => s.parentId).filter(Boolean));
        console.log("Parent IDs:", Array.from(parentIds));

        // 2ï¸âƒ£ Fetch all activities in this classroom
        const activitiesRef = collection(db, "activity");
   const activitiesQuery = query(activitiesRef, where("classroomID", "==", classId));


        
        const activitiesSnapshot = await getDocs(activitiesQuery);
console.log("Activities count:", activitiesSnapshot.size);  // Should be > 0
activitiesSnapshot.forEach(doc => console.log(doc.id, doc.data()));


        console.log("Activities snapshot:", activitiesSnapshot.docs.map(d => d.data()));

        const filteredActivities = activitiesSnapshot.docs.map(doc => doc.data());

        // 3ï¸âƒ£ Compute total/average score per student
        function calculateScores(activities) {
    return students.map(student => {
        // Filter activities for this student
        const studentActs = activities.filter(act => act.studentID === student.id);

        let totalScore = 0;
        studentActs.forEach(act => {
            const points = act.activityScore === "full" ? 100
                        : act.activityScore === "partial" ? 50
                        : 0;
            totalScore += points;
        });

        const avgScore = studentActs.length > 0 ? totalScore / studentActs.length : 0;
        return { ...student, score: avgScore };
    });
}


        const scoredStudents = calculateScores(filteredActivities);
        console.log("Scored students:", scoredStudents);

        studentCountEl.textContent = students.length;
        parentCountEl.textContent = parentIds.size;

        // 4ï¸âƒ£ Render top/low engaged students
        const sortedStudents = scoredStudents.sort((a, b) => b.score - a.score);
        console.log("Sorted students:", sortedStudents);

        topEngagedList.innerHTML = "";
        sortedStudents.slice(0, 3).forEach(student => {
            topEngagedList.innerHTML += `
                <div class="student-item">
                    <span class="student-name">${student.fullName}</span>
                    <div class="progress-bar">
                        <div class="progress-fill-green" style="width: ${student.score}%;"></div>
                    </div>
                    <span class="progress-value">${Math.round(student.score)}</span>
                </div>
            `;
        });

        lowEngagedList.innerHTML = "";
        sortedStudents.slice(-3).forEach(student => {
            lowEngagedList.innerHTML += `
                <div class="student-item">
                    <span class="student-name">${student.fullName}</span>
                    <div class="progress-bar">
                        <div class="progress-fill-red" style="width: ${student.score}%;"></div>
                    </div>
                    <span class="progress-value">${Math.round(student.score)}</span>
                </div>
            `;
        });

    } catch (err) {
        console.error("Error loading students:", err);
        studentCountEl.textContent = 0;
        parentCountEl.textContent = 0;
        topEngagedList.innerHTML = "<p>Error loading data</p>";
        lowEngagedList.innerHTML = "<p>Error loading data</p>";
    }
}

   </script>

</body>
</html>

